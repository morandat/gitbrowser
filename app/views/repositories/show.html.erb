<style type="text/css" media="screen">
  a.comment_line {
      color: rgba(155,0,0,1);
  }
  a.goto_line {
      color: rgba(0,50,200,1);
  }
  .ace_selection {
      background: rgba(0,0,0,0.1) !important;
  }
  .viewer_sel_warning {
      position:   absolute;
      background: rgba(255,255,100,0.5);
      z-index:    20
  }
  .viewer_sel_error {
      position:   absolute;
      background: rgba(255,75,50,0.3);
      z-index:    40
  }
  .viewer_tooltip {
      background-color: #FCC;
      border: 1px solid gray;
      border-radius: 1px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      color: black;
      max-width: 100%;
      padding: 3px 4px;
      position: absolute;
      z-index: 999999;
      box-sizing: border-box;
      cursor: default;
      white-space: pre;
      word-wrap: break-word;
      line-height: normal;
      font-style: normal;
      font-weight: normal;
      letter-spacing: normal;
      pointer-events: none;
  }
  .viewer_overlay {
      position:absolute;
      z-index: 100;
      padding: 5px;
      width: 300px;
      border: 1px solid black;
  }
  .viewer_overlay textarea {
      border: none;
      width: 100%;
  }
  .viewer_overlay_warning {
      background: rgba(255,255,50,0.4);
  }
  .viewer_overlay_warning textarea {
      background: rgba(255,255,200,0.7);
  }
  .viewer_overlay_error {
      background: rgba(255,100,75,0.4);
  }
  .viewer_overlay_error textarea {
      background: rgba(255,220,200,0.5);
  }
  div.destroy_button {
      position:absolute;
      left:300px; top:-1px;
      padding: 2px;
      background: white;
      border: 1px solid black;
      z-index: 99;
  }
</style>

<div style="display:flex">

  <div style="display: flex;
              flex-direction: column;">
    <div>
      <a href="<%= repositories_path %>">Repository&nbsp;:</a>
      <%= @repository.address %>
      (<a href="<%= edit_repository_path(@repository) %>">edit</a>)
      <input type="hidden" id="repository_id"
             value="<%= @repository.id %>"/>
      <input type="hidden" id="revision"
             value="<%= @selected_revision[:sha] %>"/>
      <input type="hidden" id="filename"
             value="<%= @selected_file %>"/>
    </div>

    <div>
      <select id="revision_selector" onChange="fetch_file_list()">
        <% @revisions.each_with_index do |r| %>
        <option value="<%= r[:sha] %>"
                <% if r[:sha] == @selected_revision[:sha] %>
                selected="selected"
                <% end %>
                >
          <%= r[:sha][0..6] %> - <%= r[:date] %> - <%= r[:author] %>
        </option>
        <% end %>
      </select>
    </div>

    <div style="height: 500px;">
      <ul id="file_tree">

      </ul>
    </div>
  </div>

  <div id="viewer" style="height: 900px; width: 900px; flex: 0 0 900px">

  </div>

  <div id="overlays">

  </div>

  <div id="tooltip" class="viewer_tooltip" style="display:none">

  </div>

  <div>
    <button id="warning_button">Highlight warning</button>
    <button id="error_button">Highlight error</button>
    <button id="toggle_comments">Toggle comments</button>

    Current comments&nbsp;:
    <div id="current_comments" style="background-color:rgb(200,200,255)">

    </div>

    Other comments &nbsp;:
    <div id="other_comments" style="background-color:rgb(200,200,215)">

    </div>
  </div>

</div>

<script>
  var viewer = ace.edit("viewer");
  var comments = {}; // Dict to centralize the comments
  viewer.setReadOnly(true);
  viewer.$blockScrolling = Infinity; // fix logs
  viewer.setOptions({
      highlightActiveLine: false,
      fontSize: "13pt",
      theme: 'ace/theme/chrome',
  });
  viewer.renderer.setAnimatedScroll(true);

  <% if @selected_revision %>
    fetch_file_list();
  <% end %>
  <% if @selected_file %>
    load_file("<%= @selected_file %>",
              "<%= @selected_revision[:sha] %>");
  <% end %>

  $("#warning_button").click(save_new_comment("warning"));
  $("#error_button").click(save_new_comment("error"));
  $("#toggle_comments").click(toggle_comments);
</script>
